<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
      <title>Create a cluster | ARO HCP Docs </title>
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <meta name="title" content="Create a cluster | ARO HCP Docs ">
      
      
      <link rel="icon" href="../favicon.ico">
      <link rel="stylesheet" href="../public/docfx.min.css">
      <link rel="stylesheet" href="../public/main.css">
      <meta name="docfx:navrel" content="../toc.html">
      <meta name="docfx:tocrel" content="toc.html">
      
      <meta name="docfx:rel" content="../">
      
      
      <meta name="docfx:docurl" content="https://github.com/bhardesty/aro-hcp-doc-demo/blob/main/docfx_project2/docs/create-cluster.md/#L1">
      <meta name="loc:inThisArticle" content="In this article">
      <meta name="loc:searchResultsCount" content="{count} results for &quot;{query}&quot;">
      <meta name="loc:searchNoResults" content="No results for &quot;{query}&quot;">
      <meta name="loc:tocFilter" content="Filter by title">
      <meta name="loc:nextArticle" content="Next">
      <meta name="loc:prevArticle" content="Previous">
      <meta name="loc:themeLight" content="Light">
      <meta name="loc:themeDark" content="Dark">
      <meta name="loc:themeAuto" content="Auto">
      <meta name="loc:changeTheme" content="Change theme">
      <meta name="loc:copy" content="Copy">
      <meta name="loc:downloadPdf" content="Download PDF">

      <script type="module" src="./../public/docfx.min.js"></script>

      <script>
        const theme = localStorage.getItem('theme') || 'auto'
        document.documentElement.setAttribute('data-bs-theme', theme === 'auto' ? (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light') : theme)
      </script>

  </head>

  <body class="tex2jax_ignore" data-layout="" data-yaml-mime="">
    <header class="bg-body border-bottom">
      <nav id="autocollapse" class="navbar navbar-expand-md" role="navigation">
        <div class="container-xxl flex-nowrap">
          <a class="navbar-brand" href="../index.html">
            <img id="logo" class="svg" src="../logo.svg" alt="ARO HCP Docs">
            ARO HCP Docs
          </a>
          <button class="btn btn-lg d-md-none border-0" type="button" data-bs-toggle="collapse" data-bs-target="#navpanel" aria-controls="navpanel" aria-expanded="false" aria-label="Toggle navigation">
            <i class="bi bi-three-dots"></i>
          </button>
          <div class="collapse navbar-collapse" id="navpanel">
            <div id="navbar">
              <form class="search" role="search" id="search">
                <i class="bi bi-search"></i>
                <input class="form-control" id="search-query" type="search" disabled placeholder="Search" autocomplete="off" aria-label="Search">
              </form>
            </div>
          </div>
        </div>
      </nav>
    </header>

    <main class="container-xxl">
      <div class="toc-offcanvas">
        <div class="offcanvas-md offcanvas-start" tabindex="-1" id="tocOffcanvas" aria-labelledby="tocOffcanvasLabel">
          <div class="offcanvas-header">
            <h5 class="offcanvas-title" id="tocOffcanvasLabel">Table of Contents</h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas" data-bs-target="#tocOffcanvas" aria-label="Close"></button>
          </div>
          <div class="offcanvas-body">
            <nav class="toc" id="toc"></nav>
          </div>
        </div>
      </div>

      <div class="content">
        <div class="actionbar">
          <button class="btn btn-lg border-0 d-md-none" type="button" data-bs-toggle="offcanvas" data-bs-target="#tocOffcanvas" aria-controls="tocOffcanvas" aria-expanded="false" aria-label="Show table of contents">
            <i class="bi bi-list"></i>
          </button>

          <nav id="breadcrumb"></nav>
        </div>

        <article data-uid="">
<h1 id="create-a-cluster">Create a cluster</h1>

<p>Microsoft Azure Red Hat OpenShift with hosted control planes is a managed OpenShift service that lets you quickly deploy and manage clusters. With Azure Red Hat OpenShift with hosted control planes, each cluster has a dedicated control plane that is isolated in an Azure service account.</p>
<p>This article shows you how to deploy an Azure Red Hat OpenShift with hosted control planes cluster using a Bicep file.</p>
<h2 id="prerequisites">Prerequisites</h2>
<p>Before deploying an Microsoft Azure Red Hat OpenShift with hosted control planes cluster, verify each of the following prerequisites.</p>
<h3 id="azure-cli-requirement">Azure CLI requirement</h3>
<p>Ensure you're using Azure CLI version 2.67.0 or higher. Use <code>az --version</code> to find the version of Azure CLI you installed. If you need to install or upgrade, see <a href="https://learn.microsoft.com/en-us/cli/azure/install-azure-cli">Install Azure CLI</a>.</p>
<h3 id="verify-resource-quota">Verify resource quota</h3>
<p>Ensure you have enough resource quota. Azure Red Hat OpenShift with hosted control planes requires a minimum of 20 cores to create and run an OpenShift cluster. The default Azure resource quota for a new Azure subscription doesn't meet the minimum cores requirement. To request an increase in your resource limit, see <a href="https://learn.microsoft.com/en-us/azure/azure-portal/supportability/per-vm-quota-requests">Standard quota: Increase limits by VM series</a>.</p>
<p>For example, to check the current subscription quota of the smallest supported virtual machine family SKU &quot;Standard DSv5&quot;:</p>
<pre><code>$ LOCATION=eastus
$ az vm list-usage -l $LOCATION \
  --query &quot;[?contains(name.value, 'standardDSv5Family')]&quot; -o table
</code></pre>
<h3 id="verify-permissions">Verify permissions</h3>
<p>In this article, you create a resource group which contains the virtual network and managed identities for the cluster. To create a resource group, you need Contributor and User Access Administrator permissions or Owner permissions on the resource group or subscription containing it. For more information, see <a href="https://learn.microsoft.com/en-us/azure/openshift/howto-create-openshift-cluster?tabs=bicep#verify-your-permissions">Verify your permissions</a>.</p>
<h3 id="register-resource-providers">Register resource providers</h3>
<p>The following resource providers must be registered in your Azure subscription:</p>
<ul>
<li><code>Microsoft.RedHatOpenShift</code></li>
<li><code>Microsoft.Compute</code></li>
<li><code>Microsoft.Storage</code></li>
<li><code>Microsoft.Authorization</code></li>
</ul>
<p>For more information about how to register any of these resource providers, see <a href="https://learn.microsoft.com/en-us/azure/openshift/create-cluster?tabs=azure-cli#register-the-resource-providers">Register the resource providers</a>.</p>
<h2 id="create-a-bicep-file">Create a Bicep file</h2>
<p>Create a Bicep file that defines an Azure Red Hat OpenShift with hosted control planes cluster.</p>
<h3 id="default-resources-to-define">Default resources to define</h3>
<p>To create an Azure Red Hat OpenShift with hosted control planes cluster, you must define the following resources:</p>
<ul>
<li>Network Security Group (NSG)</li>
<li>Virtual network with an empty subnet</li>
<li>A user-assigned managed identity and role assignment for each OpenShift cluster Operator</li>
<li>A service managed identity and role assignments</li>
<li>Hosted control plane (<code>Microsoft.RedHatOpenShift/hcpOpenShiftClusters</code> resource type)</li>
<li>Node pool (<code>Microsoft.RedHatOpenShift/hcpOpenShiftClusters/nodePools</code> resource type)</li>
</ul>
<h3 id="resources-to-define-for-customer-managed-etcd-encryption">Resources to define for customer-managed etcd encryption</h3>
<p>If you want to use your own key to encrypt etcd, you must also define these additional resources:</p>
<ul>
<li>Azure Key Vault</li>
<li>Custom KMS key to encrypt the etcd database</li>
<li>A user-assigned managed identity to access the KMS key, and a role assignment that grants Key Vault permissions</li>
<li>A role assignment that grants <code>Reader</code> permissions to the service managed identity</li>
</ul>
<h3 id="example-bicep-file">Example Bicep file</h3>
<p>This example Bicep file defines a cluster that uses a custom KMS key to encrypt the etcd database. You can customize the cluster and node pool configuration properties as needed.</p>
<p><strong>Example <code>azuredeploy.bicep</code> file</strong></p>
<pre><code>@description('Network Security Group Name')
param customerNsgName string

@description('Virtual Network Name')
param customerVnetName string

@description('Subnet Name')
param customerVnetSubnetName string

@description('Name of the hypershift cluster')
param clusterName string

@description('The Hypershift cluster managed resource group name')
param managedResourceGroupName string

@description('The name of the node pool')
param nodePoolName string

var randomSuffix = toLower(uniqueString(clusterName))
var addressPrefix = '10.0.0.0/16'
var subnetPrefix = '10.0.0.0/24'

resource customerNsg 'Microsoft.Network/networkSecurityGroups@2023-05-01' = {
  name: customerNsgName
  location: resourceGroup().location
  tags: {
    persist: 'true'
  }
}

resource customerVnet 'Microsoft.Network/virtualNetworks@2023-05-01' = {
  name: customerVnetName
  location: resourceGroup().location
  tags: {
    persist: 'true'
  }
  properties: {
    addressSpace: {
      addressPrefixes: [
        addressPrefix
      ]
    }
    subnets: [
      {
        name: customerVnetSubnetName
        properties: {
          addressPrefix: subnetPrefix
          networkSecurityGroup: {
            id: customerNsg.id
          }
        }
      }
    ]
  }
}

resource subnet 'Microsoft.Network/virtualNetworks/subnets@2022-07-01' existing = {
  name: customerVnetSubnetName
  parent: customerVnet
}

//
// C O N T R O L   P L A N E   I D E N T I T I E S
//

// Reader
var readerRoleId = subscriptionResourceId(
  'Microsoft.Authorization/roleDefinitions',
  'acdd72a7-3385-48ef-bd42-f606fba81ae7'
)

//
// C L U S T E R   A P I   A Z U R E   M I
//

resource clusterApiAzureMi 'Microsoft.ManagedIdentity/userAssignedIdentities@2023-01-31' = {
  name: '${clusterName}-cp-cluster-api-azure-${randomSuffix}'
  location: resourceGroup().location
}

// Azure Red Hat OpenShift Hosted Control Planes Cluster API Provider
var hcpClusterApiProviderRoleId = subscriptionResourceId(
  'Microsoft.Authorization/roleDefinitions',
  '88366f10-ed47-4cc0-9fab-c8a06148393e'
)

resource hcpClusterApiProviderRoleSubnetAssignment 'Microsoft.Authorization/roleAssignments@2022-04-01' = {
  name: guid(resourceGroup().id, clusterApiAzureMi.id, hcpClusterApiProviderRoleId, subnet.id)
  scope: subnet
  properties: {
    principalId: clusterApiAzureMi.properties.principalId
    principalType: 'ServicePrincipal'
    roleDefinitionId: hcpClusterApiProviderRoleId
  }
}

resource serviceManagedIdentityReaderOnClusterApiAzureMi 'Microsoft.Authorization/roleAssignments@2022-04-01' = {
  name: guid(resourceGroup().id, serviceManagedIdentity.id, readerRoleId, clusterApiAzureMi.id)
  scope: clusterApiAzureMi
  properties: {
    principalId: serviceManagedIdentity.properties.principalId
    principalType: 'ServicePrincipal'
    roleDefinitionId: readerRoleId
  }
}

//
// C O N T R O L   P L A N E   O P E R A T O R   M A N A G E D   I D E N T I T Y
//

resource controlPlaneMi 'Microsoft.ManagedIdentity/userAssignedIdentities@2023-01-31' = {
  name: '${clusterName}-cp-control-plane-${randomSuffix}'
  location: resourceGroup().location
}

// Azure Red Hat OpenShift Hosted Control Planes Control Plane Operator
var hcpControlPlaneOperatorRoleId = subscriptionResourceId(
  'Microsoft.Authorization/roleDefinitions',
  'fc0c873f-45e9-4d0d-a7d1-585aab30c6ed'
)

resource hcpControlPlaneOperatorVnetRoleAssignment 'Microsoft.Authorization/roleAssignments@2022-04-01' = {
  name: guid(resourceGroup().id, controlPlaneMi.id, hcpControlPlaneOperatorRoleId, customerVnet.id)
  scope: customerVnet
  properties: {
    principalId: controlPlaneMi.properties.principalId
    principalType: 'ServicePrincipal'
    roleDefinitionId: hcpControlPlaneOperatorRoleId
  }
}

resource hcpControlPlaneOperatorNsgRoleAssignment 'Microsoft.Authorization/roleAssignments@2022-04-01' = {
  name: guid(resourceGroup().id, controlPlaneMi.id, hcpControlPlaneOperatorRoleId, customerNsg.id)
  scope: customerNsg
  properties: {
    principalId: controlPlaneMi.properties.principalId
    principalType: 'ServicePrincipal'
    roleDefinitionId: hcpControlPlaneOperatorRoleId
  }
}

resource serviceManagedIdentityReaderOnControlPlaneMi 'Microsoft.Authorization/roleAssignments@2022-04-01' = {
  name: guid(resourceGroup().id, serviceManagedIdentity.id, readerRoleId, controlPlaneMi.id)
  scope: controlPlaneMi
  properties: {
    principalId: serviceManagedIdentity.properties.principalId
    principalType: 'ServicePrincipal'
    roleDefinitionId: readerRoleId
  }
}

//
// C L O U D   C O N T R O L L E R   M A N A G E R   M A N A G E D   I D E N T I T Y
//

resource cloudControllerManagerMi 'Microsoft.ManagedIdentity/userAssignedIdentities@2023-01-31' = {
  name: '${clusterName}-cp-cloud-controller-manager-${randomSuffix}'
  location: resourceGroup().location
}

// Azure Red Hat OpenShift Cloud Controller Manager
var cloudControllerManagerRoleId = subscriptionResourceId(
  'Microsoft.Authorization/roleDefinitions',
  'a1f96423-95ce-4224-ab27-4e3dc72facd4'
)

resource cloudControllerManagerRoleSubnetAssignment 'Microsoft.Authorization/roleAssignments@2022-04-01' = {
  name: guid(resourceGroup().id, cloudControllerManagerMi.id, cloudControllerManagerRoleId, subnet.id)
  scope: subnet
  properties: {
    principalId: cloudControllerManagerMi.properties.principalId
    principalType: 'ServicePrincipal'
    roleDefinitionId: cloudControllerManagerRoleId
  }
}

resource cloudControllerManagerRoleNsgAssignment 'Microsoft.Authorization/roleAssignments@2022-04-01' = {
  name: guid(resourceGroup().id, cloudControllerManagerMi.id, cloudControllerManagerRoleId, customerNsg.id)
  scope: customerNsg
  properties: {
    principalId: cloudControllerManagerMi.properties.principalId
    principalType: 'ServicePrincipal'
    roleDefinitionId: cloudControllerManagerRoleId
  }
}

resource serviceManagedIdentityReaderOnCloudControllerManagerMi 'Microsoft.Authorization/roleAssignments@2022-04-01' = {
  name: guid(resourceGroup().id, serviceManagedIdentity.id, readerRoleId, cloudControllerManagerMi.id)
  scope: cloudControllerManagerMi
  properties: {
    principalId: serviceManagedIdentity.properties.principalId
    principalType: 'ServicePrincipal'
    roleDefinitionId: readerRoleId
  }
}

//
// I N G R E S S   M A N A G E D   I D E N T I T Y
//

resource ingressMi 'Microsoft.ManagedIdentity/userAssignedIdentities@2023-01-31' = {
  name: '${clusterName}-cp-ingress-${randomSuffix}'
  location: resourceGroup().location
}

// Azure Red Hat OpenShift Cluster Ingress Operator
var ingressOperatorRoleId = subscriptionResourceId(
  'Microsoft.Authorization/roleDefinitions',
  '0336e1d3-7a87-462b-b6db-342b63f7802c'
)

resource ingressOperatorRoleSubnetAssignment 'Microsoft.Authorization/roleAssignments@2022-04-01' = {
  name: guid(resourceGroup().id, ingressMi.id, ingressOperatorRoleId, subnet.id)
  scope: subnet
  properties: {
    principalId: ingressMi.properties.principalId
    principalType: 'ServicePrincipal'
    roleDefinitionId: ingressOperatorRoleId
  }
}

resource serviceManagedIdentityReaderOnIngressMi 'Microsoft.Authorization/roleAssignments@2022-04-01' = {
  name: guid(resourceGroup().id, serviceManagedIdentity.id, readerRoleId, ingressMi.id)
  scope: ingressMi
  properties: {
    principalId: serviceManagedIdentity.properties.principalId
    principalType: 'ServicePrincipal'
    roleDefinitionId: readerRoleId
  }
}

//
// D I S K   C S I   D R I V E R   M A N A G E D   I D E N T I T Y
//

resource diskCsiDriverMi 'Microsoft.ManagedIdentity/userAssignedIdentities@2023-01-31' = {
  name: '${clusterName}-cp-disk-csi-driver-${randomSuffix}'
  location: resourceGroup().location
}

resource serviceManagedIdentityReaderOnDiskCsiDriverMi 'Microsoft.Authorization/roleAssignments@2022-04-01' = {
  name: guid(resourceGroup().id, serviceManagedIdentity.id, readerRoleId, diskCsiDriverMi.id)
  scope: diskCsiDriverMi
  properties: {
    principalId: serviceManagedIdentity.properties.principalId
    principalType: 'ServicePrincipal'
    roleDefinitionId: readerRoleId
  }
}

//
// F I L E   C S I   D R I V E R   M A N A G E D   I D E N T I T Y
//

resource fileCsiDriverMi 'Microsoft.ManagedIdentity/userAssignedIdentities@2023-01-31' = {
  name: '${clusterName}-cp-file-csi-driver-${randomSuffix}'
  location: resourceGroup().location
}

// Azure Red Hat OpenShift File Storage Operator
var fileStorageOperatorRoleId = subscriptionResourceId(
  'Microsoft.Authorization/roleDefinitions',
  '0d7aedc0-15fd-4a67-a412-efad370c947e'
)

resource fileStorageOperatorRoleSubnetAssignment 'Microsoft.Authorization/roleAssignments@2022-04-01' = {
  name: guid(resourceGroup().id, fileCsiDriverMi.id, fileStorageOperatorRoleId, subnet.id)
  scope: subnet
  properties: {
    principalId: fileCsiDriverMi.properties.principalId
    principalType: 'ServicePrincipal'
    roleDefinitionId: fileStorageOperatorRoleId
  }
}

resource fileStorageOperatorRoleNsgAssignment 'Microsoft.Authorization/roleAssignments@2022-04-01' = {
  name: guid(resourceGroup().id, fileCsiDriverMi.id, fileStorageOperatorRoleId, customerNsg.id)
  scope: customerNsg
  properties: {
    principalId: fileCsiDriverMi.properties.principalId
    principalType: 'ServicePrincipal'
    roleDefinitionId: fileStorageOperatorRoleId
  }
}

resource serviceManagedIdentityReaderOnFileCsiDriverMi 'Microsoft.Authorization/roleAssignments@2022-04-01' = {
  name: guid(resourceGroup().id, serviceManagedIdentity.id, readerRoleId, fileCsiDriverMi.id)
  scope: fileCsiDriverMi
  properties: {
    principalId: serviceManagedIdentity.properties.principalId
    principalType: 'ServicePrincipal'
    roleDefinitionId: readerRoleId
  }
}

//
// I M A G E   R E G I S T R Y   M A N A G E D   I D E N T I T Y
//

resource imageRegistryMi 'Microsoft.ManagedIdentity/userAssignedIdentities@2023-01-31' = {
  name: '${clusterName}-cp-image-registry-${randomSuffix}'
  location: resourceGroup().location
}

resource serviceManagedIdentityReaderOnImageRegistryMi 'Microsoft.Authorization/roleAssignments@2022-04-01' = {
  name: guid(resourceGroup().id, serviceManagedIdentity.id, readerRoleId, imageRegistryMi.id)
  scope: imageRegistryMi
  properties: {
    principalId: serviceManagedIdentity.properties.principalId
    principalType: 'ServicePrincipal'
    roleDefinitionId: readerRoleId
  }
}

//
// C L O U D   N E T W O R K   C O N F I G   M A N A G E D   I D E N T I T Y
//

resource cloudNetworkConfigMi 'Microsoft.ManagedIdentity/userAssignedIdentities@2023-01-31' = {
  name: '${clusterName}-cp-cloud-network-config-${randomSuffix}'
  location: resourceGroup().location
}

// Azure Red Hat OpenShift Network Operator
var networkOperatorRoleId = subscriptionResourceId(
  'Microsoft.Authorization/roleDefinitions',
  'be7a6435-15ae-4171-8f30-4a343eff9e8f'
)

resource networkOperatorRoleSubnetAssignment 'Microsoft.Authorization/roleAssignments@2022-04-01' = {
  name: guid(resourceGroup().id, cloudNetworkConfigMi.id, networkOperatorRoleId, subnet.id)
  scope: subnet
  properties: {
    principalId: cloudNetworkConfigMi.properties.principalId
    principalType: 'ServicePrincipal'
    roleDefinitionId: networkOperatorRoleId
  }
}

resource networkOperatorRoleVnetAssignment 'Microsoft.Authorization/roleAssignments@2022-04-01' = {
  name: guid(resourceGroup().id, cloudNetworkConfigMi.id, networkOperatorRoleId, customerVnet.id)
  scope: customerVnet
  properties: {
    principalId: cloudNetworkConfigMi.properties.principalId
    principalType: 'ServicePrincipal'
    roleDefinitionId: networkOperatorRoleId
  }
}

resource serviceManagedIdentityReaderOnCloudNetworkMi 'Microsoft.Authorization/roleAssignments@2022-04-01' = {
  name: guid(resourceGroup().id, serviceManagedIdentity.id, readerRoleId, cloudNetworkConfigMi.id)
  scope: cloudNetworkConfigMi
  properties: {
    principalId: serviceManagedIdentity.properties.principalId
    principalType: 'ServicePrincipal'
    roleDefinitionId: readerRoleId
  }
}

//
// D A T A P L A N E   I D E N T I T I E S
//

// Azure Red Hat OpenShift Federated Credential
// give the ability to perform OIDC federation to the service managed identity
// over the corresponding dataplane identities
var federatedCredentialsRoleId = subscriptionResourceId(
  'Microsoft.Authorization/roleDefinitions',
  'ef318e2a-8334-4a05-9e4a-295a196c6a6e'
)

resource dpDiskCsiDriverMi 'Microsoft.ManagedIdentity/userAssignedIdentities@2023-01-31' = {
  name: '${clusterName}-dp-disk-csi-driver-${randomSuffix}'
  location: resourceGroup().location
}

resource dpDiskCsiDriverMiFederatedCredentialsRoleAssignment 'Microsoft.Authorization/roleAssignments@2022-04-01' = {
  name: guid(resourceGroup().id, dpDiskCsiDriverMi.id, federatedCredentialsRoleId)
  scope: dpDiskCsiDriverMi
  properties: {
    principalId: serviceManagedIdentity.properties.principalId
    principalType: 'ServicePrincipal'
    roleDefinitionId: federatedCredentialsRoleId
  }
}

resource dpFileCsiDriverMi 'Microsoft.ManagedIdentity/userAssignedIdentities@2023-01-31' = {
  name: '${clusterName}-dp-file-csi-driver-${randomSuffix}'
  location: resourceGroup().location
}

resource dpFileCsiDriverMiFederatedCredentialsRoleAssignment 'Microsoft.Authorization/roleAssignments@2022-04-01' = {
  name: guid(resourceGroup().id, dpFileCsiDriverMi.id, federatedCredentialsRoleId)
  scope: dpFileCsiDriverMi
  properties: {
    principalId: serviceManagedIdentity.properties.principalId
    principalType: 'ServicePrincipal'
    roleDefinitionId: federatedCredentialsRoleId
  }
}

resource dpFileCsiDriverFileStorageOperatorRoleSubnetAssignment 'Microsoft.Authorization/roleAssignments@2022-04-01' = {
  name: guid(resourceGroup().id, dpFileCsiDriverMi.id, fileStorageOperatorRoleId, subnet.id)
  scope: subnet
  properties: {
    principalId: dpFileCsiDriverMi.properties.principalId
    principalType: 'ServicePrincipal'
    roleDefinitionId: fileStorageOperatorRoleId
  }
}

resource dpFileCsiDriverFileStorageOperatorRoleNsgAssignment 'Microsoft.Authorization/roleAssignments@2022-04-01' = {
  name: guid(resourceGroup().id, dpFileCsiDriverMi.id, fileStorageOperatorRoleId, customerNsg.id)
  scope: customerNsg
  properties: {
    principalId: dpFileCsiDriverMi.properties.principalId
    principalType: 'ServicePrincipal'
    roleDefinitionId: fileStorageOperatorRoleId
  }
}

resource dpImageRegistryMi 'Microsoft.ManagedIdentity/userAssignedIdentities@2023-01-31' = {
  name: '${clusterName}-dp-image-registry-${randomSuffix}'
  location: resourceGroup().location
}

resource dpImageRegistryMiFederatedCredentialsRoleAssignment 'Microsoft.Authorization/roleAssignments@2022-04-01' = {
  name: guid(resourceGroup().id, dpImageRegistryMi.id, federatedCredentialsRoleId)
  scope: dpImageRegistryMi
  properties: {
    principalId: serviceManagedIdentity.properties.principalId
    principalType: 'ServicePrincipal'
    roleDefinitionId: federatedCredentialsRoleId
  }
}

//
// S E R V I C E   M A N A G E D   I D E N T I T Y
//

resource serviceManagedIdentity 'Microsoft.ManagedIdentity/userAssignedIdentities@2023-01-31' = {
  name: '${clusterName}-service-managed-identity-${randomSuffix}'
  location: resourceGroup().location
}

// Azure Red Hat OpenShift Hosted Control Planes Service Managed Identity
var hcpServiceManagedIdentityRoleId = subscriptionResourceId(
  'Microsoft.Authorization/roleDefinitions',
  'c0ff367d-66d8-445e-917c-583feb0ef0d4'
)

// grant service managed identity role to the service managed identity over the user provided subnet
resource serviceManagedIdentityRoleAssignmentVnet 'Microsoft.Authorization/roleAssignments@2022-04-01' = {
  name: guid(resourceGroup().id, serviceManagedIdentity.id, hcpServiceManagedIdentityRoleId, customerVnet.id)
  scope: customerVnet
  properties: {
    principalId: serviceManagedIdentity.properties.principalId
    principalType: 'ServicePrincipal'
    roleDefinitionId: hcpServiceManagedIdentityRoleId
  }
}

// grant service managed identity role to the service managed identity over the user provided subnet
resource serviceManagedIdentityRoleAssignmentSubnet 'Microsoft.Authorization/roleAssignments@2022-04-01' = {
  name: guid(resourceGroup().id, serviceManagedIdentity.id, hcpServiceManagedIdentityRoleId, subnet.id)
  scope: subnet
  properties: {
    principalId: serviceManagedIdentity.properties.principalId
    principalType: 'ServicePrincipal'
    roleDefinitionId: hcpServiceManagedIdentityRoleId
  }
}

// grant service managed identity role to the service managed identity over the user provided NSG
resource serviceManagedIdentityRoleAssignmentNSG 'Microsoft.Authorization/roleAssignments@2022-04-01' = {
  name: guid(resourceGroup().id, serviceManagedIdentity.id, hcpServiceManagedIdentityRoleId, customerNsg.id)
  scope: customerNsg
  properties: {
    principalId: serviceManagedIdentity.properties.principalId
    principalType: 'ServicePrincipal'
    roleDefinitionId: hcpServiceManagedIdentityRoleId
  }
}

resource hcp 'Microsoft.RedHatOpenShift/hcpOpenShiftClusters@2024-06-10-preview' = {
  name: clusterName
  location: resourceGroup().location
  properties: {
    version: {
      id: '4.19'
      channelGroup: 'stable'
    }
    dns: {}
    network: {
      networkType: 'OVNKubernetes'
      podCidr: '10.128.0.0/14'
      serviceCidr: '172.30.0.0/16'
      machineCidr: '10.0.0.0/16'
      hostPrefix: 23
    }
    console: {}
    etcd: {
      dataEncryption: {
        keyManagementMode: 'PlatformManaged'
      }
    }
    api: {
      visibility: 'Public'
    }
    clusterImageRegistry: {
      state: 'Enabled'
    }
    platform: {
      managedResourceGroup: managedResourceGroupName
      subnetId: subnet.id
      outboundType: 'LoadBalancer'
      networkSecurityGroupId: customerNsg.id
      operatorsAuthentication: {
        userAssignedIdentities: {
          controlPlaneOperators: {
            'cluster-api-azure': clusterApiAzureMi.id
            'control-plane': controlPlaneMi.id
            'cloud-controller-manager': cloudControllerManagerMi.id
            #disable-next-line prefer-unquoted-property-names
            'ingress': ingressMi.id
            'disk-csi-driver': diskCsiDriverMi.id
            'file-csi-driver': fileCsiDriverMi.id
            'image-registry': imageRegistryMi.id
            'cloud-network-config': cloudNetworkConfigMi.id
          }
          dataPlaneOperators: {
            'disk-csi-driver': dpDiskCsiDriverMi.id
            'file-csi-driver': dpFileCsiDriverMi.id
            'image-registry': dpImageRegistryMi.id
          }
          serviceManagedIdentity: serviceManagedIdentity.id
        }
      }
    }
  }
  identity: {
    type: 'UserAssigned'
    userAssignedIdentities: {
      '${serviceManagedIdentity.id}': {}
      '${clusterApiAzureMi.id}': {}
      '${controlPlaneMi.id}': {}
      '${cloudControllerManagerMi.id}': {}
      '${ingressMi.id}': {}
      '${diskCsiDriverMi.id}': {}
      '${fileCsiDriverMi.id}': {}
      '${imageRegistryMi.id}': {}
      '${cloudNetworkConfigMi.id}': {}
    }
  }
  dependsOn: [
    hcpClusterApiProviderRoleSubnetAssignment
    hcpControlPlaneOperatorVnetRoleAssignment
    hcpControlPlaneOperatorNsgRoleAssignment
    cloudControllerManagerRoleSubnetAssignment
    cloudControllerManagerRoleNsgAssignment
    ingressOperatorRoleSubnetAssignment
    fileStorageOperatorRoleSubnetAssignment
    fileStorageOperatorRoleNsgAssignment
    networkOperatorRoleSubnetAssignment
    networkOperatorRoleVnetAssignment
    dpDiskCsiDriverMiFederatedCredentialsRoleAssignment
    dpFileCsiDriverMiFederatedCredentialsRoleAssignment
    dpImageRegistryMiFederatedCredentialsRoleAssignment
    serviceManagedIdentityRoleAssignmentVnet
    serviceManagedIdentityRoleAssignmentSubnet
    serviceManagedIdentityRoleAssignmentNSG
    dpFileCsiDriverFileStorageOperatorRoleSubnetAssignment
    dpFileCsiDriverFileStorageOperatorRoleNsgAssignment
    serviceManagedIdentityReaderOnControlPlaneMi
    serviceManagedIdentityReaderOnCloudControllerManagerMi
    serviceManagedIdentityReaderOnIngressMi
    serviceManagedIdentityReaderOnDiskCsiDriverMi
    serviceManagedIdentityReaderOnFileCsiDriverMi
    serviceManagedIdentityReaderOnImageRegistryMi
    serviceManagedIdentityReaderOnCloudNetworkMi
    serviceManagedIdentityReaderOnClusterApiAzureMi
  ]
}

resource nodepool 'Microsoft.RedHatOpenShift/hcpOpenShiftClusters/nodePools@2024-06-10-preview' = {
  parent: hcp
  name: nodePoolName
  location: resourceGroup().location
  properties: {
    version: {
      id: '4.19.0'
      channelGroup: 'stable'
    }
    platform: {
      subnetId: hcp.properties.platform.subnetId
      vmSize: 'Standard_D8s_v3'
      osDisk: {
        sizeGiB: 64
        diskStorageAccountType: 'StandardSSD_LRS'
      }
    }
    replicas: 2
  }
}	
</code></pre>
<h2 id="create-the-cluster-using-bicep">Create the cluster using Bicep</h2>
<p>This section describes how to use Bicep to create the cluster.</p>
<ol>
<li><p>Set the following variables in the shell environment that you plan to execute the az commands.</p>
<pre><code># location of your cluster
LOCATION=&quot;&lt;location&gt;&quot;

# name of your subscription
SUBSCRIPTION=&quot;&lt;subscription-name&gt;&quot;

# name of the resource group where you want to create your cluster
CUSTOMER_RG_NAME=&quot;$USER-net-rg-03&quot;

# name of the nsg
CUSTOMER_NSG=&quot;&lt;nsg-name&gt;&quot;

# name of the vnet
CUSTOMER_VNET_NAME=&quot;&lt;vnet-name&gt;&quot;

# name of the subnet within the vnet
CUSTOMER_VNET_SUBNET1=&quot;&lt;subnet-name&gt;&quot;

# name of your cluster
CLUSTER_NAME=&quot;&lt;cluster-name&gt;&quot;

# name of the managed resource group
MANAGED_RESOURCE_GROUP=&quot;$CLUSTER_NAME-rg-03&quot;

# name of the node pool
NP_NAME=&quot;&lt;node-pool-name&gt;&quot;

# optional variables for creating tags
SUBSCRIPTION_ID=$(az account show --query id --output tsv)
POLICY_DEFINITION=&quot;&lt;policy-name&gt;&quot;
POLICY_ASSIGNMENT=&quot;${POLICY_DEFINITION}-${CLUSTER_NAME}&quot;
</code></pre>
</li>
<li><p>Create a resource group to hold the cluster resource, node pool resource, and the cluster virtual network and identities.</p>
<pre><code>$ az group create \
  --name &quot;${CUSTOMER_RG_NAME}&quot; \
  --subscription &quot;${SUBSCRIPTION}&quot; \
  --location &quot;${LOCATION}&quot;
</code></pre>
</li>
<li><p>(Optional) If desired, define tags that will be applied to each of the resources in your managed resource group.</p>
<p>Follow these steps to use Azure Policy to tag the resources in your managed resource group. When you create the Azure Red Hat OpenShift with hosted control planes cluster, these tags will be applied to the managed resource group, and to each of the resources within it:</p>
<ol>
<li><p>Create the following JSON files to define the tags:</p>
<ul>
<li><a href="https://learn.microsoft.com/en-us/azure/openshift/howto-tag-resources#create-rules-file">Rules file</a></li>
<li><a href="https://learn.microsoft.com/en-us/azure/openshift/howto-tag-resources#create-parameter-definitions">Parameter definitions</a></li>
<li><a href="https://learn.microsoft.com/en-us/azure/openshift/howto-tag-resources#create-parameter-definitions">Parameter values</a></li>
</ul>
</li>
<li><p>Create the policy definition.</p>
<pre><code>$ az policy definition create -n $POLICY_DEFINITION \
  --mode All \
  --rules rules.json \
  --params param-defs.json
</code></pre>
</li>
<li><p>Create the policy assignment.</p>
<pre><code>$ az policy assignment create -n $POLICY_ASSIGNMENT \
  --policy $POLICY_DEFINITION \
  --scope &quot;/subscriptions/${SUBSCRIPTION_ID}&quot; \
  --location $LOCATION \
  --mi-system-assigned \
  --role &quot;Tag Contributor&quot; \
  --identity-scope &quot;/subscriptions/${SUBSCRIPTION_ID}&quot; \
  --params param-values.json
</code></pre>
</li>
</ol>
</li>
<li><p>Apply the Bicep file.</p>
<pre><code>$ az deployment group create \
--name 'aro-hcp' \
--subscription &quot;${SUBSCRIPTION}&quot; \
--resource-group &quot;${CUSTOMER_RG_NAME}&quot; \
--template-file azuredeploy.bicep \
--parameters \
  customerNsgName=&quot;${CUSTOMER_NSG}&quot; \
  customerVnetName=&quot;${CUSTOMER_VNET_NAME}&quot; \
  customerVnetSubnetName=&quot;${CUSTOMER_VNET_SUBNET1}&quot; \
  clusterName=&quot;${CLUSTER_NAME}&quot; \
  managedResourceGroupName=&quot;${MANAGED_RESOURCE_GROUP}&quot; \
  nodePoolName=&quot;${NP_NAME}&quot;
</code></pre>
</li>
<li><p>(Optional) If desired, create a tag for the managed resource group.</p>
<pre><code>$ az tag create \
--resource-id /subscriptions/${SUBSCRIPTION_ID}/resourcegroups/${MANAGED_RESOURCE_GROUP} \
--tags &lt;tag-key&gt;=&lt;tag-value&gt;
</code></pre>
</li>
</ol>
<h2 id="access-the-cluster">Access the cluster</h2>
<p>After creating an Azure Red Hat OpenShift with hosted control planes cluster, you can request a temporary administrative credential to access your cluster.</p>
<p>Requesting an administrative credential generates a new cluster-admin <code>kubeconfig</code> file. The <code>kubeconfig</code> file contains information about the cluster that connects a client to the correct cluster and API server. You can use the newly generated <code>kubeconfig</code> file to allow access to the cluster.</p>
<p>Administrative credentials expire after 24 hours. You can request multiple administrative credentials for a cluster. You can also revoke all administrative credentials for the cluster.</p>
<ol>
<li><p>Request an administrative credential.</p>
<pre><code>$ az rest \
  --method POST \
  --uri &quot;/subscriptions/${SUBSCRIPTION_ID}/resourceGroups/${CUSTOMER_RG_NAME}/providers/Microsoft.RedHatOpenShift/hcpOpenShiftClusters/${CLUSTER_NAME}/requestAdminCredential?api-version=2024-06-10-preview&quot; \
  --verbose
</code></pre>
<p>The admin credential is generated as an <a href="https://learn.microsoft.com/en-us/azure/azure-resource-manager/management/async-operations">asynchronous Azure operation</a>.</p>
</li>
<li><p>Monitor the status of the operation.</p>
<ol>
<li><p>In the response headers, find the URL listed in the <code>Azure-AsyncOperation</code> field.</p>
</li>
<li><p>Use the <code>Azure-AsyncOperation</code> URL to get the status.</p>
<pre><code>$ az rest \
  --method GET \
  --uri &quot;&lt;url-from-Azure-AsyncOperation-field&gt;&quot;
</code></pre>
</li>
</ol>
</li>
<li><p>Get the newly-generated <code>kubeconfig</code> content and save it as a <code>kubeconfig</code> file.</p>
<ol>
<li><p>In the response headers from the original operation, find the URL listed in the <code>Location</code> field.</p>
</li>
<li><p>Use the <code>Location</code> field URL to get the <code>kubeconfig</code> file.</p>
<pre><code>$ az rest \
  --method GET \
  --uri &quot;&lt;url-from-Location-field&gt;&quot; \
  |  jq -r '.kubeconfig' &gt; kubeconfig
</code></pre>
</li>
</ol>
</li>
<li><p>Verify that you have the correct credentials:</p>
<pre><code>$ export KUBECONFIG=kubeconfig
$ kubectl auth whoami --insecure-skip-tls-verify=true
ATTRIBUTE    VALUE
Username     system:customer-break-glass:&lt;user-id&gt;
Groups       [system:masters system:authenticated]
Extra: authentication.kubernetes.io/credential-id   &lt;credential-id&gt;
</code></pre>
</li>
<li><p>If desired, revoke all administrative credentials for the cluster:</p>
<pre><code>$ az rest \
  --method POST \
  --uri &quot;/subscriptions/${SUBSCRIPTION_ID}/resourceGroups/${CUSTOMER_RG_NAME}/providers/Microsoft.RedHatOpenShift/hcpOpenShiftClusters/${CLUSTER_NAME}/revokeCredentials?api-version=2024-06-10-preview&quot;
</code></pre>
</li>
</ol>
<h2 id="clean-up">Clean up</h2>
<p>When you are done using your Azure Red Hat OpenShift with hosted control planes cluster, you can delete it.</p>
<ol>
<li><p>Delete the cluster (the <code>hcpOpenShiftClusters</code> resource).</p>
<p>Deleting the <code>hcpOpenShiftClusters</code> resource deletes the cluster, its node pools, and the managed resource group.</p>
<pre><code>$ az rest \
  --method DELETE \
  --uri &quot;/subscriptions/${SUBSCRIPTION_ID}/resourceGroups/${CUSTOMER_RG_NAME}/providers/Microsoft.RedHatOpenShift/hcpOpenShiftClusters/${CLUSTER_NAME}?api-version=2024-06-10-preview&quot;
</code></pre>
</li>
<li><p>Verify that the cluster is deleted.</p>
<pre><code>$ az rest \
  --method GET \
  --uri &quot;/subscriptions/${SUBSCRIPTION_ID}/resourceGroups/${CUSTOMER_RG_NAME}/providers/Microsoft.RedHatOpenShift/hcpOpenShiftClusters/${CLUSTER_NAME}?api-version=2024-06-10-preview&quot;
</code></pre>
</li>
<li><p>Delete the resource group.</p>
<pre><code>$ az group delete --name ${CUSTOMER_RG_NAME}
</code></pre>
</li>
</ol>

</article>

        <div class="contribution d-print-none">
          <a href="https://github.com/bhardesty/aro-hcp-doc-demo/blob/main/docfx_project2/docs/create-cluster.md/#L1" class="edit-link">Edit this page</a>
        </div>

        <div class="next-article d-print-none border-top" id="nextArticle"></div>

      </div>

      <div class="affix">
        <nav id="affix"></nav>
      </div>
    </main>

    <div class="container-xxl search-results" id="search-results"></div>

    <footer class="border-top text-secondary">
      <div class="container-xxl">
        <div class="flex-fill">
          <span>Made with <a href="https://dotnet.github.io/docfx">docfx</a></span>
        </div>
      </div>
    </footer>
  </body>
</html>
